{% extends "base.html" %}
{% block title %}Create Walk-in Order - ABZ Hardware{% endblock %}

{% block extra_css %}
<style>
    .search-input-group {
        position: relative;
    }
    
    .search-input-group .btn {
        border-left: none;
    }
    
    .search-input-group .form-control {
        border-right: none;
    }
    
    .search-input-group .form-control:focus {
        border-right: none;
        box-shadow: none;
    }
    
    .search-input-group .btn:focus {
        box-shadow: none;
    }
    
    .product-count-info {
        font-size: 0.875rem;
        color: #6c757d;
        font-style: italic;
    }
    
    .search-active {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Search input styling */
    .searching {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
    }
    
    .searching::placeholder {
        color: #0d6efd;
        font-weight: 500;
    }
    
    #product_search.is-valid {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }
    
    #product_search:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    /* Button transitions */
    .btn {
        transition: all 0.2s ease-in-out;
    }
    
    .btn:hover {
        transform: translateY(-1px);
    }
    
    /* Product count styling */
    #product_count .text-success {
        color: #198754 !important;
    }
    
    #product_count .text-info {
        color: #0dcaf0 !important;
    }
    
    #product_count .text-danger {
        color: #dc3545 !important;
    }
    
    #product_count .text-muted {
        color: #6c757d !important;
    }
    
    /* Manual item styling */
    .table-warning {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }
    
    .table-warning:hover {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }
    
    .manual-item-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Backorder styling */
    .table-danger {
        background-color: #f8d7da !important;
    }
    
    .table-danger:hover {
        background-color: #f5c6cb !important;
    }
    
    .badge.bg-danger {
        font-size: 0.75em;
        padding: 0.25em 0.5em;
    }
    
    /* Manual item form styling */
    .manual-item-section {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    
    .manual-item-section h6 {
        color: #6c757d;
        font-weight: 600;
    }
    
    /* Order summary styling */
    .order-summary .border {
        transition: all 0.3s ease;
    }
    
    .order-summary .border:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .order-summary .text-info {
        color: #0dcaf0 !important;
    }
    
    /* Profit display styling */
    #totalProfit {
        font-weight: 700;
    }
    
    .profit-positive {
        color: #198754 !important;
    }
    
    .profit-negative {
        color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Create New Walk-in Order</h2>
    <a href="{{ url_for('orders_page') }}" class="btn btn-secondary">Back to Orders</a>
</div>

<form id="createOrderForm" method="POST">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Order Information</h5>
                </div>
                <div class="card-body">
                    <input type="hidden" id="order_type_id" name="order_type_id" value="{{ walk_in_order_type_id }}">
                    <div class="mb-3">
                        <label for="branch_id" class="form-label">Branch *</label>
                        <select class="form-select" id="branch_id" name="branch_id" required>
                            <option value="">Select Branch</option>
                            {% for branch in branches %}
                            <option value="{{ branch.id }}">{{ branch.name }} - {{ branch.location }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select the branch where this walk-in order will be processed</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Product Selection</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="category_filter" class="form-label">Filter by Category</label>
                        <select class="form-select" id="category_filter">
                            <option value="">All Categories</option>
                            {% for subcategory in subcategories %}
                            <option value="{{ subcategory.id }}">{{ subcategory.category.name }} - {{ subcategory.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="product_search" class="form-label">Search Products</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="product_search" placeholder="Type to search products...">
                            <button class="btn btn-primary" type="button" id="searchBtn">
                                <i class="bi bi-search"></i> Search
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" style="display: none;">
                                <i class="bi bi-x"></i> Clear
                            </button>
                        </div>
                        <div class="form-text">Search by product name, code, price, or stock</div>
                    </div>
                    <div class="mb-3">
                        <label for="product_select" class="form-label">Product</label>
                        <select class="form-select" id="product_select">
                            <option value="">Select Branch First</option>
                        </select>
                        <div class="form-text">
                            <span id="product_count" class="product-count-info">Please select a branch above to view available products</span>
                            <br>
                            <small class="text-info">
                                <i class="bi bi-info-circle me-1"></i>
                                You can sell products even with zero stock - the system will create backorders automatically.
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" min="1" value="1">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addProduct()">Add Product</button>
                    
                    <!-- Manual Item Section -->
                    <hr class="my-4">
                    <div class="mb-3 manual-item-section">
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-plus-circle me-2"></i>Add Manual Item
                        </h6>
                        <div class="form-text mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            Use this option to add items that are not in your product catalog (e.g., custom services, special orders, or one-time items).
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="manual_item_name" class="form-label">Item Name *</label>
                                <input type="text" class="form-control" id="manual_item_name" placeholder="Enter item name">
                            </div>
                            <div class="col-md-2">
                                <label for="manual_quantity" class="form-label">Quantity *</label>
                                <input type="number" class="form-control" id="manual_quantity" min="1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label for="manual_buying_price" class="form-label">Buying Price (KSh)</label>
                                <input type="number" class="form-control" id="manual_buying_price" min="0" step="0.01" placeholder="Cost price">
                                <div class="form-text small">Leave empty if not applicable</div>
                            </div>
                            <div class="col-md-3">
                                <label for="manual_price" class="form-label">Selling Price (KSh) *</label>
                                <input type="number" class="form-control" id="manual_price" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary" onclick="addManualItem()">
                                <i class="bi bi-plus-circle me-2"></i>Add Manual Item
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearManualItemForm()">
                                <i class="bi bi-x-circle me-2"></i>Clear Form
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Order Items</h5>
        </div>
        <div class="card-body">
            <!-- Order Summary -->
            <div id="orderSummary" class="mb-3 order-summary" style="display: none;">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="border rounded p-2">
                            <div class="h5 text-primary mb-1" id="totalItems">0</div>
                            <small class="text-muted">Total Items</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border rounded p-2">
                            <div class="h5 text-success mb-1" id="regularItems">0</div>
                            <small class="text-muted">Regular Products</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border rounded p-2">
                            <div class="h5 text-warning mb-1" id="manualItems">0</div>
                            <small class="text-muted">Manual Items</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-2">
                            <div class="h5 text-danger mb-1" id="backorderItems">0</div>
                            <small class="text-muted">Backorders</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-2">
                            <div class="h5 mb-1" id="totalProfit">KSh0.00</div>
                            <small class="text-muted">Total Profit</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="orderItems">
                <p class="text-muted">No items added yet. Add products to create your walk-in order.</p>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4>Total: KSh<span id="totalAmount">0.00</span></h4>
                <button type="submit" class="btn btn-success" id="createOrderBtn" disabled>Create Walk-in Order</button>
            </div>
        </div>
    </div>
</form>

<input type="hidden" id="orderItemsData" name="items" value="[]">
{% endblock %}

{% block scripts %}
<script>
let orderItems = [];
let products = [];
let searchQuery = '';
let searchTimeout = null;

// Load products when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners
    document.getElementById('category_filter').addEventListener('change', function() {
        // Preserve search state when changing categories
        loadProducts();
    });
    document.getElementById('product_select').addEventListener('change', updateProductInfo);
    
    // Add search functionality with proper event handling
    const searchInput = document.getElementById('product_search');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    // Search button click
    searchBtn.addEventListener('click', performSearch);
    
    // Clear search button click
    clearSearchBtn.addEventListener('click', clearSearch);
    
    // Search input events
    searchInput.addEventListener('input', function() {
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // Set new timeout for debounced search
        searchTimeout = setTimeout(() => {
            const currentValue = this.value.trim();
            if (currentValue !== searchQuery) {
                performSearch();
            }
        }, 500); // Increased to 500ms for better user experience
    });
    
    // Prevent search on every keystroke for better typing experience
    searchInput.addEventListener('keydown', function(e) {
        // Allow normal typing keys
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
        // Don't search on backspace, delete, arrow keys, etc.
        if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Tab'].includes(e.key)) {
            return;
        }
    });
});

function performSearch() {
    const searchInput = document.getElementById('product_search');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    const newSearchQuery = searchInput.value.trim();
    
    // Only perform search if query actually changed
    if (newSearchQuery === searchQuery) {
        return;
    }
    
    searchQuery = newSearchQuery;
    
    // Update UI based on search state
    if (searchQuery) {
        searchBtn.style.display = 'none';
        clearSearchBtn.style.display = 'block';
        searchInput.classList.add('is-valid');
        
        // Show loading state in clear button temporarily
        clearSearchBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Searching...';
        clearSearchBtn.disabled = true;
        
        // Add visual feedback to search input
        searchInput.classList.add('searching');
    } else {
        searchBtn.style.display = 'block';
        clearSearchBtn.style.display = 'none';
        searchInput.classList.remove('is-valid', 'searching');
    }
    
    // Load products with search
    loadProducts();
}

function clearSearch() {
    const searchInput = document.getElementById('product_search');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    // Clear the search input
    searchInput.value = '';
    searchQuery = '';
    
    // Reset UI
    searchBtn.style.display = 'block';
    clearSearchBtn.style.display = 'none';
    searchInput.classList.remove('is-valid', 'searching');
    searchInput.focus();
    
    // Load products without search
    loadProducts();
}

function loadProducts() {
    const categoryId = document.getElementById('category_filter').value;
    const branchId = document.getElementById('branch_id').value;
    
    // Don't load products if no branch is selected
    if (!branchId) {
        products = [];
        updateProductSelect();
        return;
    }
    
    // Show loading state
    const productCount = document.getElementById('product_count');
    productCount.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Loading products...';
    
    // Build API URL
    const params = new URLSearchParams();
    if (categoryId) params.append('category_id', categoryId);
    if (branchId) params.append('branch_id', branchId);
    if (searchQuery) params.append('search', searchQuery);
    
    const url = `/api/products?${params.toString()}`;
    
    // Fetch products
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Check if response has error property
            if (data && data.error) {
                throw new Error(data.error);
            }
            
            products = data || [];
            updateProductSelect();
            
            // Reset clear button state if search was performed
            if (searchQuery) {
                const clearSearchBtn = document.getElementById('clearSearchBtn');
                clearSearchBtn.innerHTML = '<i class="bi bi-x"></i> Clear';
                clearSearchBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error loading products:', error);
            productCount.innerHTML = `<span class="text-danger">Error loading products: ${error.message}</span>`;
            products = [];
            updateProductSelect();
            
            // Reset clear button state on error
            if (searchQuery) {
                const clearSearchBtn = document.getElementById('clearSearchBtn');
                clearSearchBtn.innerHTML = '<i class="bi bi-x"></i> Clear';
                clearSearchBtn.disabled = false;
            }
        });
}

function updateProductSelect() {
    const select = document.getElementById('product_select');
    const productCount = document.getElementById('product_count');
    
    // Clear existing options
    select.innerHTML = '<option value="">Select Product</option>';
    
    if (products.length === 0) {
        if (searchQuery) {
            productCount.innerHTML = `
                <div class="text-center">
                    <div class="text-muted mb-2">
                        <i class="bi bi-search"></i> No products found matching "<strong>${searchQuery}</strong>"
                    </div>
                    <div class="text-muted small">
                        Try: 
                        <button type="button" class="btn btn-link btn-sm p-0" onclick="clearSearch()">clearing the search</button>, 
                        <button type="button" class="btn btn-link btn-sm p-0" onclick="document.getElementById('category_filter').value='';loadProducts()">removing category filter</button>, 
                        or using different keywords
                    </div>
                </div>
            `;
        } else {
            productCount.innerHTML = '<span class="text-muted">No products available in this branch/category</span>';
        }
        return;
    }
    
    // Add product options
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name} - KSh${product.selling_price} (Stock: ${product.stock})`;
        select.appendChild(option);
    });
    
    // Update product count display
    if (searchQuery) {
        const searchTime = new Date().toLocaleTimeString();
        productCount.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-success">
                    <i class="bi bi-search"></i> Found <strong>${products.length}</strong> product${products.length === 1 ? '' : 's'} matching "<strong>${searchQuery}</strong>"
                </span>
                <small class="text-muted">${searchTime}</small>
            </div>
        `;
    } else {
        productCount.innerHTML = `<span class="text-info"><strong>${products.length}</strong> product${products.length === 1 ? '' : 's'} available</span>`;
    }
}

function updateProductInfo() {
    const productId = document.getElementById('product_select').value;
    const product = products.find(p => p.id == productId);
    
    if (product) {
        document.getElementById('quantity').max = product.stock;
        if (document.getElementById('quantity').value > product.stock) {
            document.getElementById('quantity').value = product.stock;
        }
    }
}

function addProduct() {
    const productId = document.getElementById('product_select').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    if (!productId) {
        alert('Please select a product.');
        return;
    }
    
    if (!quantity || quantity < 1) {
        alert('Please enter a valid quantity.');
        return;
    }
    
    const product = products.find(p => p.id == productId);
    if (!product) {
        alert('Product not found.');
        return;
    }
    
    if (quantity > product.stock) {
        // Allow the order but show a warning about insufficient stock
        const confirmLowStock = confirm(
            `Warning: You're ordering ${quantity} units of ${product.name}, but only ${product.stock} are available in stock.\n\n` +
            `This will create a backorder. Do you want to continue?`
        );
        
        if (!confirmLowStock) {
            return;
        }
    }
    
    // Check if product already exists in order
    const existingItem = orderItems.find(item => item.product_id == productId);
    if (existingItem) {
        existingItem.quantity += quantity;
        if (existingItem.quantity > product.stock) {
            // Show warning for total quantity exceeding stock
            const confirmTotalLowStock = confirm(
                `Warning: Total quantity (${existingItem.quantity}) now exceeds available stock (${product.stock}).\n\n` +
                `This will create a backorder. Do you want to continue?`
            );
            
            if (!confirmTotalLowStock) {
                existingItem.quantity -= quantity; // Revert the addition
                return;
            }
        }
    } else {
        orderItems.push({
            product_id: parseInt(productId),
            product_name: product.name,
            quantity: quantity,
            price: product.selling_price,
            buying_price: product.buyingprice || 0,
            negotiated_price: null,
            negotiation_notes: null
        });
    }
    
    updateOrderItemsDisplay();
    updateTotal();
    
    // Reset form
    document.getElementById('product_select').value = '';
    document.getElementById('quantity').value = '1';
}

function addManualItem() {
    const itemName = document.getElementById('manual_item_name').value.trim();
    const quantity = parseInt(document.getElementById('manual_quantity').value);
    const buyingPrice = parseFloat(document.getElementById('manual_buying_price').value) || 0;
    const price = parseFloat(document.getElementById('manual_price').value);

    if (!itemName) {
        alert('Item name cannot be empty.');
        document.getElementById('manual_item_name').focus();
        return;
    }

    if (!quantity || quantity < 1) {
        alert('Quantity must be at least 1.');
        document.getElementById('manual_quantity').focus();
        return;
    }

    if (!price || price < 0) {
        alert('Selling price must be a positive number.');
        document.getElementById('manual_price').focus();
        return;
    }

    // Check if item already exists in order (case-insensitive)
    const existingItem = orderItems.find(item => 
        item.product_name.toLowerCase() === itemName.toLowerCase()
    );
    
    if (existingItem) {
        const confirmAdd = confirm(`Item "${itemName}" already exists in the order. Do you want to add ${quantity} more units?`);
        if (confirmAdd) {
            existingItem.quantity += quantity;
            updateOrderItemsDisplay();
            updateTotal();
            clearManualItemForm();
        }
        return;
    }

    // Add new manual item
    orderItems.push({
        product_id: null, // No direct product ID for manual items
        product_name: itemName,
        quantity: quantity,
        price: price,
        buying_price: buyingPrice,
        negotiated_price: null,
        negotiation_notes: null
    });

    updateOrderItemsDisplay();
    updateTotal();
    clearManualItemForm();
    
    // Show success message
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-success alert-dismissible fade show mt-2';
    successMsg.innerHTML = `
        <i class="bi bi-check-circle me-2"></i>
        Manual item "${itemName}" added successfully!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.manual-item-section').appendChild(successMsg);
    
    // Auto-remove success message after 3 seconds
    setTimeout(() => {
        if (successMsg.parentNode) {
            successMsg.remove();
        }
    }, 3000);
}

function clearManualItemForm() {
    document.getElementById('manual_item_name').value = '';
    document.getElementById('manual_quantity').value = '1';
    document.getElementById('manual_buying_price').value = '';
    document.getElementById('manual_price').value = '';
    document.getElementById('manual_item_name').focus();
}

function removeProduct(index) {
    orderItems.splice(index, 1);
    updateOrderItemsDisplay();
    updateTotal();
}



function updateOrderItemsDisplay() {
    const container = document.getElementById('orderItems');
    const summaryDiv = document.getElementById('orderSummary');
    
    if (orderItems.length === 0) {
        container.innerHTML = '<p class="text-muted">No items added yet.</p>';
        summaryDiv.style.display = 'none';
        return;
    }
    
    // Update summary
    const regularItems = orderItems.filter(item => item.product_id !== null).length;
    const manualItems = orderItems.filter(item => item.product_id === null).length;
    const totalItems = orderItems.length;
    
    // Count backorder items
    const backorderItems = orderItems.filter(item => {
        if (item.product_id === null) return false; // Skip manual items
        const product = products.find(p => p.id === item.product_id);
        return product && item.quantity > product.stock;
    }).length;
    
    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('regularItems').textContent = regularItems;
    document.getElementById('manualItems').textContent = manualItems;
    document.getElementById('backorderItems').textContent = backorderItems;
    summaryDiv.style.display = 'block';
    
    let html = `
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Buying Price</th>
                    <th>Selling Price</th>
                    <th>Negotiated Price</th>
                    <th>Final Price</th>
                    <th>Total</th>
                    <th>Notes</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    orderItems.forEach((item, index) => {
        const finalPrice = item.negotiated_price || item.price;
        const total = item.quantity * finalPrice;
        const isManualItem = item.product_id === null;
        const buyingPrice = item.buying_price || 0;
        
        // Check if this is a backorder (regular product with quantity exceeding stock)
        let isBackorder = false;
        let availableStock = 0;
        if (!isManualItem && item.product_id) {
            const product = products.find(p => p.id === item.product_id);
            if (product && item.quantity > product.stock) {
                isBackorder = true;
                availableStock = product.stock;
            }
        }
        
        // Determine row class based on item type and stock status
        let rowClass = '';
        if (isManualItem) {
            rowClass = 'table-warning';
        } else if (isBackorder) {
            rowClass = 'table-danger';
        }
        
        html += `
            <tr class="${rowClass}">
                <td>
                    ${item.product_name}
                    ${isManualItem ? '<span class="badge bg-warning text-dark ms-2">Manual</span>' : ''}
                    ${isBackorder ? '<span class="badge bg-danger ms-2">Backorder</span>' : ''}
                </td>
                <td>
                    <input type="number" 
                           class="form-control form-control-sm quantity-input" 
                           value="${item.quantity}" 
                           min="1"
                           data-index="${index}"
                           onchange="updateQuantity(${index}, this.value)">
                    ${isBackorder ? `<br><small class="text-danger">(${availableStock} in stock)</small>` : ''}
                </td>
                <td>KSh${buyingPrice.toFixed(2)}</td>
                <td>KSh${item.price.toFixed(2)}</td>
                <td>
                    <input type="number" 
                           class="form-control form-control-sm negotiated-price" 
                           value="${item.negotiated_price || item.price}" 
                           step="0.01" 
                           min="0"
                           onchange="updateNegotiatedPrice(${index}, this.value)">
                </td>
                <td class="final-price">KSh${finalPrice.toFixed(2)}</td>
                <td class="item-total">KSh${total.toFixed(2)}</td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           placeholder="Notes..."
                           value="${item.negotiation_notes || ''}"
                           onchange="updateNegotiationNotes(${index}, this.value)">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeProduct(${index})">
                        Remove
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function updateNegotiatedPrice(index, newPrice) {
    const item = orderItems[index];
    const originalPrice = item.price;
    const negotiatedPrice = parseFloat(newPrice) || originalPrice;
    
    item.negotiated_price = negotiatedPrice !== originalPrice ? negotiatedPrice : null;
    updateOrderItemsDisplay();
    updateTotal();
}

function updateNegotiationNotes(index, notes) {
    orderItems[index].negotiation_notes = notes.trim() || null;
}

function updateQuantity(index, newQuantity) {
    const quantity = parseInt(newQuantity);
    if (quantity < 1) {
        alert('Quantity must be at least 1.');
        return;
    }

    const item = orderItems[index];
    
    // For regular products, check stock availability
    if (item.product_id) {
        const product = products.find(p => p.id === item.product_id);
        if (product && quantity > product.stock) {
            // Allow the quantity but show a warning about insufficient stock
            const confirmLowStock = confirm(
                `Warning: You're setting quantity to ${quantity} units of ${item.product_name}, but only ${product.stock} are available in stock.\n\n` +
                `This will create a backorder. Do you want to continue?`
            );
            
            if (!confirmLowStock) {
                return;
            }
        }
    }
    // For manual items, no stock restrictions

    item.quantity = quantity;
    updateOrderItemsDisplay();
    updateTotal();
}

function updateTotal() {
    const total = orderItems.reduce((sum, item) => {
        const finalPrice = item.negotiated_price || item.price;
        return sum + (item.quantity * finalPrice);
    }, 0);
    document.getElementById('totalAmount').textContent = total.toFixed(2);
    document.getElementById('orderItemsData').value = JSON.stringify(orderItems);
    document.getElementById('createOrderBtn').disabled = orderItems.length === 0;

    // Calculate total profit
    const totalProfit = orderItems.reduce((sum, item) => {
        const buyingPrice = item.buying_price || 0;
        const sellingPrice = item.negotiated_price || item.price;
        return sum + (sellingPrice - buyingPrice) * item.quantity;
    }, 0);
    document.getElementById('totalProfit').textContent = `KSh${totalProfit.toFixed(2)}`;
    document.getElementById('totalProfit').classList.remove('profit-positive', 'profit-negative');
    if (totalProfit >= 0) {
        document.getElementById('totalProfit').classList.add('profit-positive');
    } else {
        document.getElementById('totalProfit').classList.add('profit-negative');
    }
}

// Handle form submission
document.getElementById('createOrderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (orderItems.length === 0) {
        alert('Please add at least one product to the order.');
        return;
    }
    
    const formData = new FormData(this);
    formData.set('items', JSON.stringify(orderItems));
    
    // Show loading state
    const submitBtn = document.getElementById('createOrderBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Creating...';
    submitBtn.disabled = true;
    
    fetch('/orders/create', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(`Order created successfully! Order ID: ${data.order_id}`);
            window.location.href = `/orders/${data.order_id}`;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the order. Please try again.');
    })
    .finally(() => {
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Update products when branch changes
document.getElementById('branch_id').addEventListener('change', function() {
    // Clear current products but preserve order items when branch changes
    products = [];
    
    // Clear search query and reset search UI
    searchQuery = '';
    const searchInput = document.getElementById('product_search');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    searchInput.value = '';
    searchInput.classList.remove('is-valid');
    searchBtn.style.display = 'block';
    clearSearchBtn.style.display = 'none';
    
    // Clear product selection
    document.getElementById('product_select').innerHTML = '<option value="">Select Product</option>';
    
    // Update product count message
    document.getElementById('product_count').textContent = 'Please select a branch above to view available products';
    
    // Load products for the new branch
    loadProducts();
    
    // Refresh the order items display to ensure everything is shown correctly
    if (orderItems.length > 0) {
        updateOrderItemsDisplay();
        updateTotal();
        
        // Show a message that order items are preserved
        const messageDiv = document.createElement('div');
        messageDiv.className = 'alert alert-info alert-dismissible fade show mt-2';
        messageDiv.innerHTML = `
            <i class="bi bi-info-circle me-2"></i>
            <strong>Branch changed!</strong> Your ${orderItems.length} order item(s) have been preserved. 
            You can now add products from the new branch.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert the message after the branch selection
        const branchCard = document.querySelector('.card:has(#branch_id)');
        if (branchCard) {
            branchCard.parentNode.insertBefore(messageDiv, branchCard.nextSibling);
        }
        
        // Auto-remove message after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %} 